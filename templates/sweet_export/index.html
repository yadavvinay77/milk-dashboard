{% extends "layout.html" %}
{% block content %}
<div class="container mt-4">
    <div class="row">
        <!-- Customer List Sidebar -->
        <div class="col-md-3">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5>Customers</h5>
                    <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addCustomerModal">+</button>
                </div>
                <div class="card-body p-0">
                    <ul class="list-group list-group-flush">
                        {% for customer in customers %}
                        <li class="list-group-item {% if selected_customer and selected_customer.id == customer.id %}active{% endif %}">
                            <div class="d-flex justify-content-between align-items-center">
                                <a href="{{ url_for('sweet_export_bp.index', customer_id=customer.id) }}" 
                                   class="text-decoration-none {% if selected_customer and selected_customer.id == customer.id %}text-white{% else %}text-dark{% endif %}">
                                    {{ customer.name }}
                                </a>
                                <form method="post" action="{{ url_for('sweet_export_bp.delete_customer', id=customer.id) }}" 
                                      class="d-inline" onsubmit="return confirm('Delete this customer and all transactions?')">
                                    <button type="submit" class="btn btn-sm btn-danger">×</button>
                                </form>
                            </div>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="col-md-9">
            <h3>Sweet Export (Khoya Sales) {% if selected_customer %} - {{ selected_customer.name }}{% endif %}</h3>
            
            {% if selected_customer %}
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addTransactionModal">+ Add Khoya Sale</button>
                    <button class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#addCreditModal">+ Add Credit</button>
                </div>
                <div>
                    <a href="?customer_id={{ selected_customer.id }}&export=csv&from={{ d_from }}&to={{ d_to }}" 
                       class="btn btn-outline-success">Export CSV</a>
                    <a href="?customer_id={{ selected_customer.id }}&export=xlsx&from={{ d_from }}&to={{ d_to }}" 
                       class="btn btn-outline-success">Export Excel</a>
                </div>
            </div>

            <form method="get" class="row mb-3">
                <div class="col-md-3">
                    <input type="date" name="from" class="form-control" value="{{ d_from }}">
                </div>
                <div class="col-md-3">
                    <input type="date" name="to" class="form-control" value="{{ d_to }}">
                </div>
                <input type="hidden" name="customer_id" value="{{ selected_customer.id }}">
                <div class="col-md-2">
                    <button class="btn btn-info w-100">Filter</button>
                </div>
            </form>

            <table class="table table-bordered table-striped">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Type</th>
                        <th>Weight (kg)</th>
                        <th>Rate</th>
                        <th>Amount</th>
                        <th>Credit</th>
                        <th>Note</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for log in logs %}
                    <tr>
                        <td>{{ log.date|dmy }}</td>
                        <td>{{ log.khoya_type }}</td>
                        <td>{{ '%.2f'|format(log.weight) }}</td>
                        <td>₹ {{ '%.2f'|format(log.rate) }}</td>
                        <td>₹ {{ '%.2f'|format(log.amount) }}</td>
                        <td>₹ {{ '%.2f'|format(log.credit) }}</td>
                        <td>{{ log.note }}</td>
                        <td>
                            <a href="{{ url_for('sweet_export_bp.invoice', id=log.id) }}" 
                            class="btn btn-sm btn-info">Invoice</a>
                            <a href="{{ url_for('sweet_export_bp.edit_transaction', id=log.id) }}" class="btn btn-sm btn-outline-primary">Edit</a>
                            <form method="post" action="{{ url_for('sweet_export_bp.delete_transaction', id=log.id) }}" 
                                class="d-inline" onsubmit="return confirm('Delete this transaction?')">
                                <button class="btn btn-sm btn-danger">Delete</button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot>
                    {% set total_weight = logs|sum(attribute='weight') %}
                    {% set total_amount = logs|sum(attribute='amount') %}
                    {% set total_credit = logs|sum(attribute='credit') %}
                    <tr class="fw-bold">
                        <td colspan="2">Totals</td>
                        <td>{{ '%.2f'|format(total_weight) }}</td>
                        <td></td>
                        <td>₹ {{ '%.2f'|format(total_amount) }}</td>
                        <td>₹ {{ '%.2f'|format(total_credit) }}</td>
                        <td colspan="2">Balance: ₹ {{ '%.2f'|format(total_amount - total_credit) }}</td>
                    </tr>
                    <tr>
                        <td colspan="8" class="text-center">
                            <div class="btn-group">
                                <button class="btn btn-outline-primary" onclick="filterByType('all')">All</button>
                                <button class="btn btn-outline-success" onclick="filterByType('Cow_Khoya')">Cow Khoya</button>
                                <button class="btn btn-outline-info" onclick="filterByType('Buffalo_Khoya')">Buffalo Khoya</button>
                                <button class="btn btn-outline-warning" onclick="filterByType('credit')">Credits</button>
                                <button class="btn btn-outline-dark" onclick="window.print()">Print Statement</button>
                            </div>
                        </td>
                    </tr>
                </tfoot>
            </table>
            {% else %}
            <div class="alert alert-info">
                Please select a customer from the left sidebar to view and add transactions.
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Add Customer Modal -->
<div class="modal fade" id="addCustomerModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Customer</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="{{ url_for('sweet_export_bp.add_customer') }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Name</label>
                        <input type="text" name="name" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Phone</label>
                        <input type="text" name="phone" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Address</label>
                        <textarea name="address" class="form-control"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add Transaction Modal -->
<!-- In the Add Transaction Modal -->
<div class="modal fade" id="addTransactionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Khoya Sale</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="{{ url_for('sweet_export_bp.add_transaction') }}" id="transactionForm">
                <input type="hidden" name="customer_id" value="{{ selected_customer.id if selected_customer }}">
                <input type="hidden" name="generate_invoice" value="yes">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Date</label>
                        <input type="date" name="date" class="form-control" value="{{ today }}" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Khoya Type</label>
                        <div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="khoya_type" id="cow_khoya" value="Cow_Khoya" checked>
                                <label class="form-check-label" for="cow_khoya">Cow Khoya</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="khoya_type" id="buffalo_khoya" value="Buffalo_Khoya">
                                <label class="form-check-label" for="buffalo_khoya">Buffalo Khoya</label>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Weight (kg)</label>
                        <input type="number" step="0.01" name="weight" class="form-control" required oninput="calculateSweetAmount()">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Rate</label>
                        <input type="number" step="0.01" name="rate" class="form-control" value="310" required oninput="calculateSweetAmount()">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Amount</label>
                        <input type="number" step="0.01" name="amount" id="sweet_amount" class="form-control" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Note</label>
                        <input type="text" name="note" class="form-control">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save & Generate Invoice</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add Credit Modal -->
<div class="modal fade" id="addCreditModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Credit Transaction</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="{{ url_for('sweet_export_bp.add_credit') }}">
                <input type="hidden" name="customer_id" value="{{ selected_customer.id if selected_customer }}">
                <input type="hidden" name="generate_invoice" value="yes">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Date</label>
                        <input type="date" name="date" class="form-control" value="{{ today }}">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Credit Amount</label>
                        <input type="number" step="0.01" name="credit" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Note</label>
                        <input type="text" name="note" class="form-control">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-warning">Save Credit</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function calculateSweetAmount() {
    const weight = parseFloat(document.querySelector('input[name="weight"]').value) || 0;
    const rate = parseFloat(document.querySelector('input[name="rate"]').value) || 0;
    const amount = weight * rate;
    document.getElementById('sweet_amount').value = amount.toFixed(2);
}

function filterByType(type) {
    const url = new URL(window.location.href);
    if (type === 'all') {
        url.searchParams.delete('type');
    } else {
        url.searchParams.set('type', type);
    }
    window.location.href = url.toString();
}

// Initialize form
document.addEventListener('DOMContentLoaded', function() {
    calculateSweetAmount();
});
</script>
{% endblock %}